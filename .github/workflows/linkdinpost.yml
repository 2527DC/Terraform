name: Post to LinkedIn on Changes

on:
    push:
        branches:
            - main
            - dev
        paths:
            - "post.txt"

jobs:
    linkedin-post:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            # Read post.txt and escape content safely
            - name: Read and Escape post content
              id: readfile
              run: |
                  RAW_CONTENT=$(cat post.txt)
                  ESCAPED_CONTENT=$(printf '%s' "$RAW_CONTENT" | jq -Rs .)
                  echo "ESCAPED_POST_TEXT=$ESCAPED_CONTENT" >> $GITHUB_ENV

            # üî• NEW: Dynamically get LinkedIn User ID (no need for URN secret)
            - name: Get LinkedIn User ID (URN)
              id: getuser
              run: |
                  USERINFO=$(curl -s -H "Authorization: Bearer ${{ secrets.LINKEDIN_ACCESS_TOKEN }}" https://api.linkedin.com/v2/userinfo)

                  echo "Userinfo Response: $USERINFO"

                  USER_ID=$(echo $USERINFO | jq -r '.sub')

                  if [ "$USER_ID" = "null" ] || [ -z "$USER_ID" ]; then
                    echo "‚ùå Failed to get LinkedIn User ID"
                    exit 1
                  fi

                  URN="urn:li:person:$USER_ID"
                  echo "LINKEDIN_URN=$URN" >> $GITHUB_ENV

                  echo "Using URN: $URN"

            # Post to LinkedIn
            - name: Post to LinkedIn
              run: |
                  echo "Posting to LinkedIn..."

                  RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
                    -X POST "https://api.linkedin.com/v2/ugcPosts" \
                    -H "Authorization: Bearer ${{ secrets.LINKEDIN_ACCESS_TOKEN }}" \
                    -H "X-Restli-Protocol-Version: 2.0.0" \
                    -H "Content-Type: application/json" \
                    -d "{
                      \"author\": \"${{ env.LINKEDIN_URN }}\",
                      \"lifecycleState\": \"PUBLISHED\",
                      \"specificContent\": {
                        \"com.linkedin.ugc.ShareContent\": {
                          \"shareCommentary\": { \"text\": ${ESCAPED_POST_TEXT} },
                          \"shareMediaCategory\": \"NONE\"
                        }
                      },
                      \"visibility\": {
                        \"com.linkedin.ugc.MemberNetworkVisibility\": \"PUBLIC\"
                      }
                    }")

                  echo "LinkedIn Response:"
                  cat response.json
                  echo "Status Code: $RESPONSE"

                  if [ "$RESPONSE" -ne 201 ]; then
                    echo "‚ùå LinkedIn API failed with status $RESPONSE"
                    exit 1
                  fi

                  echo "‚úÖ Successfully posted to LinkedIn!"
